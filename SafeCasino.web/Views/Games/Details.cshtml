@model SafeCasino.Web.ViewModels.GameDetailsViewModel
@{
    ViewData["Title"] = Model.Game.Name;
}

<div class="container py-4">
    <!-- Game Header -->
    <div class="row mb-4">
        <div class="col-md-4">
            <img src="@Model.Game.ThumbnailUrl" class="img-fluid rounded shadow" alt="@Model.Game.Name"
                 onerror="this.src='/images/placeholder-game.jpg'" />
        </div>
        <div class="col-md-8">
            <div class="d-flex justify-content-between align-items-start mb-3">
                <div>
                    <h1 class="display-5">@Model.Game.Name</h1>
                    <p class="lead text-muted">@Model.Game.Provider.Name</p>
                </div>
                <div>
                    @if (Model.Game.IsNew)
                    {
                        <span class="badge bg-success fs-6">Nieuw</span>
                    }
                    @if (Model.Game.IsPopular)
                    {
                        <span class="badge bg-warning text-dark fs-6">Populair</span>
                    }
                </div>
            </div>

            <p class="mb-4">@Model.Game.Description</p>

            <!-- Game Stats -->
            <div class="row g-3 mb-4">
                <div class="col-md-3">
                    <div class="card text-center">
                        <div class="card-body">
                            <h6 class="text-muted mb-1">RTP</h6>
                            <h4 class="mb-0">@Model.Game.RtpPercentage%</h4>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card text-center">
                        <div class="card-body">
                            <h6 class="text-muted mb-1">Min. Inzet</h6>
                            <h4 class="mb-0">€@Model.Game.MinimumBet</h4>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card text-center">
                        <div class="card-body">
                            <h6 class="text-muted mb-1">Max. Inzet</h6>
                            <h4 class="mb-0">€@Model.Game.MaximumBet</h4>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card text-center">
                        <div class="card-body">
                            <h6 class="text-muted mb-1">Gespeeld</h6>
                            <h4 class="mb-0">@Model.Game.PlayCount</h4>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Action Buttons -->
            <div class="d-grid gap-2 d-md-flex">
                @if (User.Identity?.IsAuthenticated == true)
                {
                    <a asp-action="Play" asp-route-id="@Model.Game.Id" class="btn btn-primary btn-lg">
                        <i class="fas fa-play"></i> Speel Nu
                    </a>
                }
                else
                {
                    <a asp-action="Login" asp-controller="Account" asp-route-returnUrl="@Url.Action("Play", new { id = Model.Game.Id })"
                       class="btn btn-primary btn-lg">
                        <i class="fas fa-sign-in-alt"></i> Log in om te spelen
                    </a>
                }
                <a asp-action="Index" class="btn btn-outline-secondary btn-lg">
                    <i class="fas fa-arrow-left"></i> Terug naar overzicht
                </a>
            </div>
        </div>
    </div>

    <hr class="my-5" />

    <!-- ============ AJAX: REVIEWS SECTION ============ -->
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <div>
                    <h2>Reviews</h2>
                    @if (Model.TotalReviews > 0)
                    {
                        <p class="text-muted">
                            <i class="fas fa-star text-warning"></i>
                            <span id="avgRating">@Model.AverageRating.ToString("F1")</span> / 5.0
                            (<span id="totalReviewCount">@Model.TotalReviews</span> reviews)
                        </p>
                    }
                    else
                    {
                        <p class="text-muted">Nog geen reviews</p>
                    }
                </div>
                @if (Model.CanReview && !Model.UserHasReviewed)
                {
                    <a asp-controller="Reviews" asp-action="Create" asp-route-gameId="@Model.Game.Id"
                       class="btn btn-success">
                        <i class="fas fa-plus"></i> Review schrijven
                    </a>
                }
                else if (Model.UserHasReviewed)
                {
                    <span class="badge bg-info">Je hebt dit spel al beoordeeld</span>
                }
            </div>

            <!-- Reviews List -->
            <div id="reviewsContainer">
                @if (Model.Reviews.Any())
                {
                    <div class="row row-cols-1 g-4" id="reviewsList">
                        @foreach (var review in Model.Reviews)
                        {
                            <div class="col review-item">
                                <div class="card">
                                    <div class="card-body">
                                        <div class="d-flex justify-content-between align-items-start mb-2">
                                            <div>
                                                <h5 class="card-title mb-1">@review.Title</h5>
                                                <p class="text-muted mb-2">
                                                    <small>
                                                        door @review.User.FirstName @review.User.LastName -
                                                        @review.CreatedDate.ToString("dd MMM yyyy")
                                                    </small>
                                                </p>
                                            </div>
                                            <div>
                                                @for (int i = 1; i <= 5; i++)
                                                {
                                                    if (i <= review.Rating)
                                                    {
                                                        <i class="fas fa-star text-warning"></i>
                                                    }
                                                    else
                                                    {
                                                        <i class="far fa-star text-warning"></i>
                                                    }
                                                }
                                            </div>
                                        </div>
                                        <p class="card-text">@review.Content</p>

                                        @if (User.Identity?.Name == review.User.UserName)
                                        {
                                            <div class="mt-3">
                                                <a asp-controller="Reviews" asp-action="Edit" asp-route-id="@review.Id"
                                                   class="btn btn-sm btn-outline-primary">
                                                    <i class="fas fa-edit"></i> Bewerken
                                                </a>
                                                <form asp-controller="Reviews" asp-action="Delete" asp-route-id="@review.Id"
                                                      method="post" class="d-inline"
                                                      onsubmit="return confirm('Weet je zeker dat je deze review wilt verwijderen?')">
                                                    <button type="submit" class="btn btn-sm btn-outline-danger">
                                                        <i class="fas fa-trash"></i> Verwijderen
                                                    </button>
                                                </form>
                                            </div>
                                        }
                                    </div>
                                </div>
                            </div>
                        }
                    </div>
                }
                else
                {
                    <div class="text-center py-5" id="noReviewsMessage">
                        <i class="fas fa-comment-slash fa-3x text-muted mb-3"></i>
                        <p class="text-muted">Nog geen reviews voor dit spel. Wees de eerste!</p>
                    </div>
                }
            </div>

            <!-- ============ AJAX: LOAD MORE REVIEWS BUTTON ============ -->
            @if (Model.TotalReviews > Model.Reviews.Count)
            {
                <div class="row mt-4">
                    <div class="col-12 text-center">
                        <button id="loadMoreReviewsBtn" class="btn btn-outline-primary btn-lg" data-page="2" data-game-id="@Model.Game.Id">
                            <i class="fas fa-spinner"></i> Meer Reviews Laden
                        </button>
                        <p class="text-muted small mt-2">
                            <span id="loadedReviewCount">@Model.Reviews.Count</span> / <span id="totalReviewCount2">@Model.TotalReviews</span> reviews geladen
                        </p>
                    </div>
                </div>
            }
        </div>
    </div>
</div>

@section Styles {
    <style>
        /* ============ AJAX REVIEWS LOADING STYLES ============ */
        #reviewsContainer {
            animation: fadeIn 0.3s ease-in;
        }

        .review-item {
            animation: slideInUp 0.4s ease-out;
        }

        #loadMoreReviewsBtn {
            transition: all 0.3s ease;
        }

            #loadMoreReviewsBtn:disabled {
                opacity: 0.6;
                cursor: not-allowed;
            }

            #loadMoreReviewsBtn.loading {
                opacity: 0.7;
            }

        .review-skeleton {
            background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
            background-size: 200% 100%;
            animation: loading 1.5s infinite;
        }

        @@keyframes loading {
            0% {
                background-position: 200% 0;
            }

            100% {
                background-position: -200% 0;
            }
        }

        @@keyframes slideInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @@keyframes fadeIn {
            from {
                opacity: 0;
            }

            to {
                opacity: 1;
            }
        }

        .card {
            transition: all 0.3s ease;
            border: none;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

            .card:hover {
                transform: translateY(-2px);
                box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            }
    </style>
}

@section Scripts {
    <script>
        // ============ AJAX: LOAD MORE REVIEWS ============
        const loadMoreBtn = document.getElementById('loadMoreReviewsBtn');

        if (loadMoreBtn) {
            loadMoreBtn.addEventListener('click', async function() {
                const gameId = this.dataset.gameId;
                const page = parseInt(this.dataset.page);

                // Disable button en toon loading
                this.disabled = true;
                this.classList.add('loading');
                const originalHTML = this.innerHTML;
                this.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Laden...';

                try {
                    const response = await fetch(`/Games/LoadReviews?gameId=${gameId}&page=${page}`);
                    const result = await response.json();

                    if (!result.success) {
                        showNotification('❌ Fout bij laden reviews', 'error');
                        return;
                    }

                    // Verwijder "geen reviews" bericht als zichtbaar
                    const noReviewsMsg = document.getElementById('noReviewsMessage');
                    if (noReviewsMsg) {
                        noReviewsMsg.remove();
                    }

                    // Voeg reviews toe
                    const reviewsList = document.getElementById('reviewsList');
                    result.data.forEach((review, index) => {
                        const reviewHTML = createReviewHTML(review);
                        const tempDiv = document.createElement('div');
                        tempDiv.innerHTML = reviewHTML;
                        reviewsList.appendChild(tempDiv.firstElementChild);

                        // Stagger animation
                        setTimeout(() => {
                            tempDiv.firstElementChild.classList.add('review-item');
                        }, index * 100);
                    });

                    // Update counts
                    const loadedCount = parseInt(document.getElementById('loadedReviewCount').textContent);
                    document.getElementById('loadedReviewCount').textContent = loadedCount + result.data.length;

                    // Update button
                    this.dataset.page = result.nextPage;

                    if (!result.hasMore) {
                        this.remove(); // Verwijder button als geen meer reviews
                        showNotification('✅ Alle reviews geladen!', 'success');
                    } else {
                        this.disabled = false;
                        this.classList.remove('loading');
                        this.innerHTML = originalHTML;
                    }

                    console.log(`⭐ Loaded ${result.data.length} reviews | Page: ${page} | Total: ${result.totalReviews}`);

                } catch (error) {
                    console.error('❌ Error loading reviews:', error);
                    this.disabled = false;
                    this.classList.remove('loading');
                    this.innerHTML = originalHTML;
                    showNotification('❌ Fout bij laden reviews', 'error');
                }
            });
        }

        // Helper function om review HTML te genereren
        function createReviewHTML(review) {
            const stars = Array(5).fill().map((_, i) => {
                return i < review.rating ?
                    '<i class="fas fa-star text-warning"></i>' :
                    '<i class="far fa-star text-warning"></i>';
            }).join('');

            return `
                <div class="col review-item">
                    <div class="card">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-start mb-2">
                                <div>
                                    <h5 class="card-title mb-1">${review.title}</h5>
                                    <p class="text-muted mb-2">
                                        <small>door ${review.userName} - ${review.createdDate}</small>
                                    </p>
                                </div>
                                <div>${stars}</div>
                            </div>
                            <p class="card-text">${review.content}</p>
                        </div>
                    </div>
                </div>
            `;
        }

        // Notification helper
        function showNotification(message, type = 'info') {
            const alertClass = type === 'success' ? 'alert-success' : 'alert-danger';
            const alertHTML = `
                <div class="alert ${alertClass} alert-dismissible fade show" role="alert">
                    ${message}
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
            `;

            const container = document.querySelector('.container.py-4');
            const tempDiv = document.createElement('div');
            tempDiv.innerHTML = alertHTML;
            container.insertBefore(tempDiv.firstElementChild, container.firstChild);
        }
    </script>
}
